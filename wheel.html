<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Wheel of Fortune</title>
    <style>
        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            font-family: sans-serif;
            padding: 0;
            background-color: #f2dcbd;
        }
        canvas {
            width: 100%;      /* ✅ Fill screen width */
            height: auto;     /* ✅ Keep aspect ratio */
            max-width: 970px; /* ✅ Optional: cap for large screens */
            margin: 20px;
        }
        button {
            padding: 10px 20px;
            font-size: 60px;
            cursor: pointer;
            margin-bottom: 20px;
            width: 300px;
            height: 100px;
        }
    </style>
</head>
<body>

<canvas id="wheel" width="500" height="600" ></canvas>
<button onclick="spin()">Spin</button>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>

<script>
    const colors = ["#fcb410", "#f6901e", "#ed3224", "#be1e2d", "#fcb410", "#f6901e", "#ed3224", "#be1e2d", "#fcb410", "#f6901e", "#ed3224", "#be1e2d", "#fcb410", "#f6901e", "#ed3224", "#be1e2d"];
    const canvas = document.getElementById("wheel");
    const ctx = canvas.getContext("2d");

    const firebaseConfig = {
        apiKey: "AIzaSyDOqoQmTmtK_UOv6mjDEz039YkTCj5O01I",
        authDomain: "rectuitment-wheel.firebaseapp.com",
        databaseURL: "https://rectuitment-wheel-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "rectuitment-wheel",
        storageBucket: "rectuitment-wheel.firebasestorage.app",
        messagingSenderId: "8507591213",
        appId: "1:8507591213:web:8b04ed5535a6fb226e46a4"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let gifts = { "Example Gift": 1 };
    let slices = [];

    // Evenly distribute duplicates
    function buildSlices() {
        let distributed = [];
        let maxCount = Math.max(...Object.values(gifts));
        for (let i = 0; i < maxCount; i++) {
            for (let [name, count] of Object.entries(gifts)) {
                if (i < count) distributed.push(name);
            }
        }
        return distributed;
    }

    function normalizeAngle(a) {
        const twoPi = 2 * Math.PI;
        return ((a % twoPi) + twoPi) % twoPi;
    }

    function drawWheel(rotation = 0) {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        const radius = 250;
        const centerX = 250;
        const centerY = 350;

        if (!slices || slices.length === 0) {
            // nothing to draw
            // (optional: draw a placeholder)
            return;
        }

        const sliceAngle = 2 * Math.PI / slices.length;

        // Draw slices
        slices.forEach((text, i) => {
            const angle = i * sliceAngle + rotation;
            ctx.beginPath();
            ctx.moveTo(centerX, centerY);
            ctx.arc(centerX, centerY, radius, angle, angle + sliceAngle);
            ctx.fillStyle = colors[i % colors.length];
            ctx.fill();
            ctx.stroke();

            // Draw text
            ctx.save();
            ctx.translate(centerX, centerY);
            ctx.rotate(angle + sliceAngle / 2);
            ctx.textAlign = "right";
            ctx.fillStyle = "#000000";
            ctx.font = "28px 'Times New Roman'";
            ctx.fillText(text, radius - 10, 5);
            ctx.restore();
        });

        // Draw arrow (outside, pointing downward toward wheel — arrow tip located above wheel)
        ctx.beginPath();
        ctx.moveTo(centerX, centerY - radius - 20);      // tip pointing downward
        ctx.lineTo(centerX - 15, centerY - radius - 50); // left corner
        ctx.lineTo(centerX + 15, centerY - radius - 50); // right corner
        ctx.closePath();
        ctx.fillStyle = "#000";
        ctx.fill();
    }

    let spinning = false, rotation = Math.random(), speed = 0;

    function animateTo(targetRotation, winnerIndex) {
        const duration = 4000; // ms
        const startRotation = rotation;
        const startTime = performance.now();

        function step(now) {
            const elapsed = now - startTime;
            const t = Math.min(elapsed / duration, 1);
            const eased = 1 - Math.pow(1 - t, 3); // cubic ease-out

            rotation = startRotation + (targetRotation - startRotation) * eased;
            drawWheel(rotation);

            if (t < 1) {
                requestAnimationFrame(step);
            } else {
                rotation = targetRotation;
                drawWheel(rotation);

                spinning = false;
                celebrate();
            }
        }

        requestAnimationFrame(step);
    }

    function spin() {
        if (spinning || !slices || slices.length === 0) return;

        const sliceAngle = 2 * Math.PI / slices.length;

        // Pick winner first
        const winnerIndex = Math.floor(Math.random() * slices.length);

        // Middle angle of winner slice (in wheel coords)
        const winnerMidAngle = winnerIndex * sliceAngle + sliceAngle / 2;

        // Arrow is at the TOP (12 o'clock) = -90deg = -π/2
        const arrowAngle = -Math.PI / 2;

        // Rotation needed so winnerMidAngle aligns with arrowAngle
        const desiredRotationOffset = normalizeAngle(arrowAngle - winnerMidAngle);

        // Add extra full spins
        const extraSpins = Math.floor(Math.random() * 3) + 5;
        const targetRotation = rotation + extraSpins * 2 * Math.PI + desiredRotationOffset;

        spinning = true;
        animateTo(targetRotation, winnerIndex);
    }

    function celebrate() {
        // burst
        confetti({
            particleCount: 150,
            spread: 70,
            origin: { y: 0.6 }
        });

        // fireworks style
        const duration = 2 * 1000;
        const end = Date.now() + duration;

        (function frame() {
            confetti({
                particleCount: 3,
                angle: 60,
                spread: 55,
                origin: { x: 0 }
            });
            confetti({
                particleCount: 3,
                angle: 120,
                spread: 55,
                origin: { x: 1 }
            });

            if (Date.now() < end) {
                requestAnimationFrame(frame);
            }
        }());
    }

    db.ref('wheel/data').on('value', snapshot => {
        gifts = snapshot.val() || {};
        slices = buildSlices();
        drawWheel(rotation);
    });

    drawWheel();
</script>
</body>
</html>
